(function(c){function n(){h=c.grep(h,function(b){return b.length&&b.data("edatagrid")})}function r(b){n();c.map(h,function(a){a[0]!=c(b)[0]&&a.edatagrid("saveRow")});n()}function t(b){n();h=c.grep(h,function(a){return c(a)[0]!=c(b)[0]})}function u(b){var a=c.data(b,"edatagrid").options;c(b).datagrid(c.extend({},a,{onDblClickCell:function(f,d,e){a.editing&&(c(this).edatagrid("editRow",f),p(b,d));a.onDblClickCell&&a.onDblClickCell.call(b,f,d,e)},onClickCell:function(f,d,e){if(0<=a.editIndex){var g=c(this);a.editing?g.edatagrid("editRow",f):setTimeout(function(){g.edatagrid("selectRow",a.editIndex)},0);p(b,d)}a.onClickCell&&a.onClickCell.call(b,f,d,e)},onBeforeEdit:function(f,d){if(a.onBeforeEdit&&0==a.onBeforeEdit.call(b,f,d))return!1;if(a.autoSave)a:{n();for(f=0;f<h.length;f++)if(c(h[f])[0]==c(this)[0])break a;h.push(c(this))}a.originalRow=c.extend(!0,[],d)},onAfterEdit:function(f,d){if("undefined"==typeof afterRowEdit||0!=afterRowEdit(f)){t(this);a.editIndex=-1;var e=d.isNewRecord?a.saveUrl:a.updateUrl;if(e){for(var g=!1,l=c(this).edatagrid("getColumnFields",!0).concat(c(this).edatagrid("getColumnFields")),q=0;q<l.length;q++){var m=l[q];if(c(this).edatagrid("getColumnOption",m).editor&&a.originalRow[m]!=d[m]){g=!0;break}}g?a.poster.call(b,e,d,function(e){if(e.isError){var g=a.originalRow;c(b).edatagrid("cancelRow",f);c(b).edatagrid("selectRow",f);c(b).edatagrid("editRow",f);a.originalRow=g;a.onError.call(b,f,e)}else{e.isNewRecord=null;c(b).datagrid("updateRow",{index:f,row:e});if(a.tree){e=d[a.idField||"id"];var g=c(a.tree),k=g.tree("find",e);k?(k.text=d[a.treeTextField],g.tree("update",k)):(k=g.tree("find",d[a.treeParentField]),g.tree("append",{parent:k?k.target:null,data:[{id:e,text:d[a.treeTextField]}]}))}a.onSuccess.call(b,f,d);a.onSave.call(b,f,d)}},function(c){a.onError.call(b,f,c)}):a.onSave.call(b,f,d)}else d.isNewRecord=!1,a.onSave.call(b,f,d);a.onAfterEdit&&a.onAfterEdit.call(b,f,d)}},onCancelEdit:function(f,d){t(this);a.editIndex=-1;d.isNewRecord&&c(this).datagrid("deleteRow",f);a.onCancelEdit&&a.onCancelEdit.call(b,f,d)},onBeforeLoad:function(f){if(0==a.onBeforeLoad.call(b,f))return!1;c(this).edatagrid("cancelRow");if(a.tree){var d=c(a.tree).tree("getSelected");f[a.treeParentField]=d?d.id:void 0}}}));a.tree&&c(a.tree).tree({url:a.treeUrl,onClick:function(a){c(b).datagrid("load")},onDrop:function(f,d,e){f=c(this).tree("getNode",f).id;a.poster.call(b,a.treeDndUrl,{id:d.id,targetId:f,point:e},function(a){c(b).datagrid("load")})}})}function p(b,a){var f=c(b).edatagrid("options"),d;(a=c(b).datagrid("getEditor",{index:f.editIndex,field:a}))?d=a.target:(b=c(b).datagrid("getEditors",f.editIndex),b.length&&(d=b[0].target));d&&(c(d).hasClass("textbox-f")?c(d).textbox("textbox").focus():c(d).focus())}var h=[];c(function(){c(document).unbind(".edatagrid").bind("mousedown.edatagrid",function(b){b=c(b.target).closest("div.datagrid-view,div.combo-panel,div.window,div.window-mask");b.length?b.hasClass("datagrid-view")&&r(b.children("table")):r()})});c.fn.edatagrid=function(b,a){if("string"==typeof b){var f=c.fn.edatagrid.methods[b];return f?f(this,a):this.datagrid(b,a)}b=b||{};return this.each(function(){var a=c.data(this,"edatagrid");a?c.extend(a.options,b):c.data(this,"edatagrid",{options:c.extend({},c.fn.edatagrid.defaults,c.fn.edatagrid.parseOptions(this),b)});u(this)})};c.fn.edatagrid.parseOptions=function(b){return c.extend({},c.fn.datagrid.parseOptions(b),{})};c.fn.edatagrid.methods={options:function(b){return c.data(b[0],"edatagrid").options},loadData:function(b,a){return b.each(function(){c(this).edatagrid("cancelRow");c(this).datagrid("loadData",a)})},enableEditing:function(b){return b.each(function(){c.data(this,"edatagrid").options.editing=!0})},disableEditing:function(b){return b.each(function(){var a=c.data(this,"edatagrid").options;console.log(a);a.editing=!1})},isEditing:function(b,a){b=c.data(b[0],"edatagrid").options.finder.getTr(b[0],a);return b.length&&b.hasClass("datagrid-row-editing")},editRow:function(b,a){return b.each(function(){var b=c(this),d=c.data(this,"edatagrid").options,e=d.editIndex;if(e!=a)if(b.datagrid("validateRow",e))if(0<=e&&0==d.onBeforeSave.call(this,e))setTimeout(function(){b.datagrid("selectRow",e)},0);else{if(b.datagrid("endEdit",e),b.datagrid("beginEdit",a),b.edatagrid("isEditing",a)){d.editIndex=a;p(this);var g=b.datagrid("getRows");d.onEdit.call(this,a,g[a])}}else setTimeout(function(){b.datagrid("selectRow",e)},0)})},addRow:function(b,a){return b.each(function(){function b(a,b){void 0==a?(d.datagrid("appendRow",b),e.editIndex=d.datagrid("getRows").length-1):(d.datagrid("insertRow",{index:a,row:b}),e.editIndex=a)}var d=c(this),e=c.data(this,"edatagrid").options;if(0<=e.editIndex){if(!d.datagrid("validateRow",e.editIndex)){d.datagrid("selectRow",e.editIndex);return}if(0==e.onBeforeSave.call(this,e.editIndex)){setTimeout(function(){d.datagrid("selectRow",e.editIndex)},0);return}d.datagrid("endEdit",e.editIndex)}"object"==typeof a?b(a.index,c.extend(a.row,{isNewRecord:!0})):b(a,{isNewRecord:!0});d.datagrid("beginEdit",e.editIndex);d.datagrid("selectRow",e.editIndex);var g=d.datagrid("getRows");if(e.tree){var l=c(e.tree).tree("getSelected");g[e.editIndex][e.treeParentField]=l?l.id:0}e.onAdd.call(this,e.editIndex,g[e.editIndex])})},saveRow:function(b){return b.each(function(){var a=c(this),b=c.data(this,"edatagrid").options;0<=b.editIndex&&(0==b.onBeforeSave.call(this,b.editIndex)?setTimeout(function(){a.datagrid("selectRow",b.editIndex)},0):c(this).datagrid("endEdit",b.editIndex))})},cancelRow:function(b){return b.each(function(){var b=c.data(this,"edatagrid").options;0<=b.editIndex&&c(this).datagrid("cancelEdit",b.editIndex)})},destroyRow:function(b,a){return b.each(function(){function b(b){var a=d.datagrid("getRowIndex",b);if(-1!=a)if(b.isNewRecord)d.datagrid("cancelEdit",a);else if(e.destroyUrl){var f=b[e.idField||"id"];e.poster.call(d[0],e.destroyUrl,{id:f},function(a){var g=d.datagrid("getRowIndex",f);if(a.isError)d.datagrid("selectRow",g),e.onError.call(d[0],g,a);else{if(e.tree){d.datagrid("reload");var h=c(e.tree),k=h.tree("find",f);k&&h.tree("remove",k.target)}else d.datagrid("cancelEdit",g),d.datagrid("deleteRow",g);e.onDestroy.call(d[0],g,c.extend(b,a));a=d.datagrid("getPager");a.length&&!d.datagrid("getRows").length&&(d.datagrid("options").pageNumber=a.pagination("options").pageNumber,d.datagrid("reload"))}},function(b){e.onError.call(d[0],a,b)})}else d.datagrid("cancelEdit",a),d.datagrid("deleteRow",a),e.onDestroy.call(d[0],a,b)}var d=c(this),e=c.data(this,"edatagrid").options,g=[];if(void 0==a)g=d.datagrid("getSelections");else for(var l=c.isArray(a)?a:[a],h=0;h<l.length;h++){var m=e.finder.getRow(this,l[h]);m&&g.push(m)}g.length?c.messager.confirm(e.destroyMsg.confirm.title,e.destroyMsg.confirm.msg,function(a){if(a){for(a=0;a<g.length;a++)b(g[a]);d.datagrid("clearSelections")}}):c.messager.show({title:e.destroyMsg.norecord.title,msg:e.destroyMsg.norecord.msg})})}};c.fn.edatagrid.defaults=c.extend({},c.fn.datagrid.defaults,{singleSelect:!0,editing:!0,editIndex:-1,destroyMsg:{norecord:{title:"Warning",msg:"No record is selected."},confirm:{title:"Confirm",msg:"Are you sure you want to delete?"}},poster:function(b,a,f,d){c.ajax({type:"post",url:b,data:a,dataType:"json",success:function(a){f(a)},error:function(a,b,c){d({jqXHR:a,textStatus:b,errorThrown:c})}})},autoSave:!1,url:null,saveUrl:null,updateUrl:null,destroyUrl:null,tree:null,treeUrl:null,treeDndUrl:null,treeTextField:"name",treeParentField:"parentId",onAdd:function(b,a){},onEdit:function(b,a){},onBeforeSave:function(b){},onSave:function(b,a){},onSuccess:function(b,a){},onDestroy:function(b,a){},onError:function(b,a){}});c.parser.plugins.push("edatagrid")})(jQuery);