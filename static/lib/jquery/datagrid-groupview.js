$.extend($.fn.datagrid.defaults,{groupHeight:25,expanderWidth:30,groupStyler:function(b,a){return""}});var groupview=$.extend({},$.fn.datagrid.defaults.view,{render:function(b,a,c){for(var d=[],e=this.groups,f=0;f<e.length;f++)d.push(this.renderGroup.call(this,b,f,e[f],c));$(a).html(d.join(""))},renderGroup:function(b,a,c,d){var e=$.data(b,"datagrid"),f=e.options,l=$(b).datagrid("getColumnFields",d),g=f.frozenColumns&&f.frozenColumns.length;if(d&&!f.rownumbers&&!g)return"";var h=[],k=f.groupStyler.call(b,c.value,c.rows),n="",m="";"string"==typeof k?m=k:k&&(n=k["class"]||"",m=k.style||"");h.push("<div group-index="+a+" "+('class="datagrid-group'+(n?" "+n:"")+'" style="'+m+'"')+">");if(d&&(f.rownumbers||f.frozenColumns.length)||!d&&!f.rownumbers&&!f.frozenColumns.length)h.push('<span class="datagrid-group-expander">'),h.push('<span class="datagrid-row-expander datagrid-row-collapse">&nbsp;</span>'),h.push("</span>");if(d&&g||!d)h.push('<span class="datagrid-group-title">'),h.push(f.groupFormatter.call(b,c.value,c.rows)),h.push("</span>");h.push("</div>");h.push('<table class="datagrid-btable" cellspacing="0" cellpadding="0" border="0"><tbody>');a=c.startIndex;for(g=0;g<c.rows.length;g++)k=f.rowStyler?f.rowStyler.call(b,a,c.rows[g]):"",m=n="","string"==typeof k?m=k:k&&(n=k["class"]||"",m=k.style||""),h.push('<tr id="'+(e.rowIdPrefix+"-"+(d?1:2)+"-"+a)+'" datagrid-row-index="'+a+'" '+('class="datagrid-row '+(a%2&&f.striped?"datagrid-row-alt ":" ")+n+'"')+" "+(m?'style="'+m+'"':"")+">"),h.push(this.renderRow.call(this,b,l,d,a,c.rows[g])),h.push("</tr>"),a++;h.push("</tbody></table>");return h.join("")},bindEvents:function(b){var a=$.data(b,"datagrid").dc,a=a.body1.add(a.body2),c=($.data(a[0],"events")||$._data(a[0],"events")).click[0].handler;a.unbind("click").bind("click",function(a){var d=$(a.target).closest("span.datagrid-row-expander");if(d.length){var f=d.closest("div.datagrid-group").attr("group-index");d.hasClass("datagrid-row-collapse")?$(b).datagrid("collapseGroup",f):$(b).datagrid("expandGroup",f)}else c(a);a.stopPropagation()})},onBeforeRender:function(b,a){function c(a){for(var c=0;c<f.length;c++){var b=f[c];if(b.value==a)return b}return null}var d=$.data(b,"datagrid"),e=d.options;$("#datagrid-group-style").length||$("head").append('<style id="datagrid-group-style">.datagrid-group{height:'+e.groupHeight+"px;overflow:hidden;font-weight:bold;border-bottom:1px solid #ccc;white-space:nowrap;word-break:normal;}.datagrid-group-title,.datagrid-group-expander{display:inline-block;vertical-align:bottom;height:100%;line-height:"+e.groupHeight+"px;padding:0 4px;}.datagrid-group-title{position:relative;}.datagrid-group-expander{width:"+e.expanderWidth+"px;text-align:center;padding:0}.datagrid-row-expander{margin:"+Math.floor((e.groupHeight-16)/2)+"px 0;display:inline-block;width:16px;height:16px;cursor:pointer}</style>");for(var f=[],l=0;l<a.length;l++){var g=a[l],h=c(g[e.groupField]);h?h.rows.push(g):(h={value:g[e.groupField],rows:[g]},f.push(h))}a=0;e=[];for(l=0;l<f.length;l++)h=f[l],h.startIndex=a,a+=h.rows.length,e=e.concat(h.rows);d.data.rows=e;this.groups=f;var k=this;setTimeout(function(){k.bindEvents(b)},0)},onAfterRender:function(b){$.fn.datagrid.defaults.view.onAfterRender.call(this,b);var a=this,c=$.data(b,"datagrid"),d=c.options;c.onResizeColumn||(c.onResizeColumn=d.onResizeColumn);c.onResize||(c.onResize=d.onResize);d.onResizeColumn=function(d,f){a.resizeGroup(b);c.onResizeColumn.call(b,d,f)};d.onResize=function(d,f){a.resizeGroup(b);c.onResize.call($(b).datagrid("getPanel")[0],d,f)};a.resizeGroup(b)}});$.extend($.fn.datagrid.methods,{groups:function(b){return b.datagrid("options").view.groups},expandGroup:function(b,a){return b.each(function(){var c=$.data(this,"datagrid").dc.view.find(void 0!=a?'div.datagrid-group[group-index="'+a+'"]':"div.datagrid-group"),b=c.find("span.datagrid-row-expander");b.hasClass("datagrid-row-expand")&&(b.removeClass("datagrid-row-expand").addClass("datagrid-row-collapse"),c.next("table").show());$(this).datagrid("fixRowHeight")})},collapseGroup:function(b,a){return b.each(function(){var c=$.data(this,"datagrid").dc.view.find(void 0!=a?'div.datagrid-group[group-index="'+a+'"]':"div.datagrid-group"),b=c.find("span.datagrid-row-expander");b.hasClass("datagrid-row-collapse")&&(b.removeClass("datagrid-row-collapse").addClass("datagrid-row-expand"),c.next("table").hide());$(this).datagrid("fixRowHeight")})},scrollToGroup:function(b,a){return b.each(function(){var c=$.data(this,"datagrid").dc,b=c.body2.children('div.datagrid-group[group-index="'+a+'"]');if(b.length){var e=b.outerHeight(),f=c.view2.children("div.datagrid-header")._outerHeight(),l=c.body2.outerHeight(!0)-c.body2.outerHeight(),b=b.position().top-f-l;0>b?c.body2.scrollTop(c.body2.scrollTop()+b):b+e>c.body2.height()-18&&c.body2.scrollTop(c.body2.scrollTop()+b+e-c.body2.height()+18)}})}});$.extend(groupview,{refreshGroupTitle:function(b,a){var c=$.data(b,"datagrid"),d=c.options,c=c.dc,e=this.groups[a];c.body1.add(c.body2).children("div.datagrid-group[group-index="+a+"]").find("span.datagrid-group-title").html(d.groupFormatter.call(b,e.value,e.rows))},resizeGroup:function(b,a){var c=$.data(b,"datagrid"),d=c.dc,e=d.header2.find("table");b=e.find("tr.datagrid-filter-row").hide();e=e.width();a=void 0==a?d.body2.children("div.datagrid-group"):d.body2.children("div.datagrid-group[group-index="+a+"]");a._outerWidth(e);c=c.options;c.frozenColumns&&c.frozenColumns.length&&(e=d.view1.width()-c.expanderWidth,d="rtl"==d.view1.css("direction").toLowerCase(),a.find(".datagrid-group-title").css(d?"right":"left",-e+"px"));b.length&&c.showFilterBar&&b.show()},insertRow:function(b,a,c){function d(a,c){c=c?1:2;var d=f.finder.getTr(b,a-1,"body",c);f.finder.getTr(b,a,"body",c).insertAfter(d)}var e=$.data(b,"datagrid"),f=e.options,l=e.dc,g=null,h;if(e.data.rows.length){for(var k=0;k<this.groups.length;k++)if(this.groups[k].value==c[f.groupField]){g=this.groups[k];h=k;break}if(g){if(void 0==a||null==a)a=e.data.rows.length;a<g.startIndex?a=g.startIndex:a>g.startIndex+g.rows.length&&(a=g.startIndex+g.rows.length);$.fn.datagrid.defaults.view.insertRow.call(this,b,a,c);a>=g.startIndex+g.rows.length&&(d(a,!0),d(a,!1));g.rows.splice(a-g.startIndex,0,c)}else g={value:c[f.groupField],rows:[c],startIndex:e.data.rows.length},h=this.groups.length,l.body1.append(this.renderGroup.call(this,b,h,g,!0)),l.body2.append(this.renderGroup.call(this,b,h,g,!1)),this.groups.push(g),e.data.rows.push(c);this.setGroupIndex(b);this.refreshGroupTitle(b,h);this.resizeGroup(b)}else $(b).datagrid("loadData",[c])},updateRow:function(b,a,c){var d=$.data(b,"datagrid").options;$.fn.datagrid.defaults.view.updateRow.call(this,b,a,c);a=d.finder.getTr(b,a,"body",2).closest("table.datagrid-btable");a=parseInt(a.prev().attr("group-index"));this.refreshGroupTitle(b,a)},deleteRow:function(b,a){var c=$.data(b,"datagrid"),d=c.options,c=c.dc,c=c.body1.add(c.body2),d=d.finder.getTr(b,a,"body",2).closest("table.datagrid-btable"),d=parseInt(d.prev().attr("group-index"));$.fn.datagrid.defaults.view.deleteRow.call(this,b,a);var e=this.groups[d];if(1<e.rows.length)e.rows.splice(a-e.startIndex,1),this.refreshGroupTitle(b,d);else{c.children("div.datagrid-group[group-index="+d+"]").remove();for(a=d+1;a<this.groups.length;a++)c.children("div.datagrid-group[group-index="+a+"]").attr("group-index",a-1);this.groups.splice(d,1)}this.setGroupIndex(b)},setGroupIndex:function(b){for(var a=b=0;a<this.groups.length;a++){var c=this.groups[a];c.startIndex=b;b+=c.rows.length}}});