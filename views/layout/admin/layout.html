<!-- 用于列表页 -->
<!DOCTYPE html>
<html>
<head>
{{ template "layout/admin/head.html" .}}
</head>

<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
    {{ template "layout/admin/sidebar.html" }}
    {{ template "layout/admin/header.html" .}}
    <!-- 内容主体区域 -->
    <div class="content-body">
        <div class="layui-tab layui-tab-brief" lay-filter="ok-tab" lay-allowClose="true">
            <ul class="layui-tab-title">
                <li class="layui-this" lay-id="111"><i class="layui-icon">&#xe68e;</i> 控制台</li>
            </ul>
            <div class="layui-tab-content">
                <div class="layui-tab-item layui-show">
                    <iframe src='{{urlfor "AdminController.Index"}}' frameborder="0" scrolling="yes" width="100%" height="100%"></iframe>
                </div>
            </div>
        </div>
    </div>

    <!--底部信息-->
    <div class="layui-footer">
        <button class="layui-btn layui-btn-danger layui-btn-xs donate">Skr</button>
    </div>
</div>
<script src="/static/lib/nprogress/nprogress.js"></script>
<script src="/static/js/okadmin.js"></script>
<script>
    new Vue({
        el: '#sidebar',
        data: {
            menuList : ''
        },
        created(){
        },
        methods: {
            loadMenu() {
                let _this = this;
                $c.ajax('{{urlfor "MenuController.UserMenuTree"}}',{}, function (ret) {
                    if(ret.code === 0){
                        _this.menuList = _this.initMenu(ret.data);
                        console.log(_this.menuList);
                    }else{
                        $c.error(_this,ret.message);
                    }
                })
            },
            initMenu(data) {
                let _this = this;
                let menu = [];
                $(data).filter(function (i, e) {
                    //找出父节点
                    let is_child =  e.Parent.Id === 0;
                    if (is_child) {
                        e.Sons = [];
                        menu.push(e);
                    }
                    return is_child;
                }).each(function (i, e) {
                    //菜单
                    if (e.Type === 1) {
                        //递归加载子节点
                        _this.addSonNode(e, data);
                    } else if (e.Type === 0) {
                        //如果是区域，先添加header
                        //添加区域的子节点
                        // $(data).filter(function (i1, e1) {
                        //     return e1.Parent.Id === e.Id;
                        // }).each(function (i2, e2) {
                        //     //递归调用，显示子节点
                        //
                        // });
                    }
                });
                return menu;
            },
            //cur 是实参
            addSonNode(cur, list) {
                let _this = this;
                if (!$c.isEmpty(cur.SonNum) && cur.SonNum > 0) {
                    $(list).filter(function (i, e) {
                        let is_child =  e.Parent.Id === cur.Id;
                        if (is_child) {
                            e.Sons = [];
                            cur.Sons.push(e);
                        }
                        return is_child;
                    }).each(function (i, e) {
                        //递归调用，显示子节点
                        _this.addSonNode(e, list);
                    });
                } else {
                    cur.Sons = [];
                }
            }
        },
        mounted: function () {
            this.loadMenu();
        }
    });

    // 跟表单元素一样，很多时候你的页面元素可能是动态生成的，
    // 这时element的相关功能将不会对其有效，你必须手工执行 element.init(type, filter) 方法即可。
    // 注意：2.1.6 开始，可以用 element.render(type, filter); 方法替代
    // 第一个参数：type，为表单的type类型，可选。默认对全部类型的表单进行一次更新。可局部刷新的type如下表：  tab、nav、breadcrumb、progress、collapse
    // 第二个参数：filter，为元素的 lay-filter="" 的值。你可以借助该参数，完成指定元素的局部更新。
    // element.init(); //更新全部  2.1.6 可用 element.render() 方法替代
    // element.render('nav'); //重新对导航进行渲染。注：layui 2.1.6 版本新增

    //比如当你对导航动态插入了二级菜单，这时你需要重新去对它进行渲染
    // element.render('nav', 'test1'); //对 lay-filter="test1" 所在导航重新渲染。注：layui 2.1.6 版本新增

    layui.use('element', function(){
        let element = layui.element;

        //监听选项卡切换
        element.on('tab(ok-tab)', function(data){
            console.log(this); //当前Tab标题所在的原始DOM元素
            console.log(data.index); //得到当前Tab的所在下标
            console.log(data.elem); //得到当前的Tab大容器

            //监听Tab切换，以改变地址hash值
            location.hash = 'ok-tab='+ this.getAttribute('lay-id');
        });

        //监听选项卡删除
        element.on('tabDelete(filter)', function(data){
            console.log(this); //当前Tab标题所在的原始DOM元素
            console.log(data.index); //得到当前Tab的所在下标
            console.log(data.elem); //得到当前的Tab大容器
        });

        //监听导航菜单的点击   没有存在该菜单对应的选项卡则生成，
        element.on('nav(sidebar-nav)', function(elem){
            console.log("click sidebar-nav"); //得到当前点击的DOM对象
            console.log(elem); //得到当前点击的DOM对象
            //没有存在该菜单对应的选项卡则生成
            element.tabAdd('ok-tab', {
                title: '选项卡的标题'
                ,content: '选项卡的内容' //支持传入html
                ,id: '选项卡标题的lay-id属性值'
            });

            // 已有则切换至该选项卡
            // 用于外部切换到指定的Tab项上，参数同上，如： element.tabChange('demo', 'layid'); //切换到 lay-id="yyy" 的这一项
            //获取hash来切换选项卡，假设当前地址的hash为lay-id对应的值
            let layid = location.hash.replace(/^#ok-tab=/, '');
            element.tabChange('ok-tab', layid); //假设当前地址为：http://a.com#test1=222，那么选项卡会自动切换到“发送消息”这一项

        });
    });
</script>
</body>

</html>